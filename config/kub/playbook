#!/bin/ansible-playbook
# -*- mode: yaml -*-
- hosts: k
  become: yes
  vars:
    network: 10.117.14
    address: "{{ network }}.54"
  tasks:
    - pacman: name={{ item.name }}
      with_items:
        - name: atop
        - name: parallel
        - name: tmux
        - name: tree
        - name: vim
        - name: zsh

    - template: src=eth0.network dest=/etc/systemd/network/eth0.network
    - lineinfile: dest=/etc/resolv.conf line="nameserver {{ network }}.1"
    - service: name=systemd-networkd state=started enabled=yes

    - copy: src=leds dest=/usr/local/bin/leds mode=744
    - template: src=leds.service dest=/etc/systemd/system/leds.service
    - service: name=leds state=started enabled=yes

    - pacman: name=minidlna
    - template: src=minidlna.conf dest=/etc/minidlna.conf
    - template: src=minidlna_home.conf dest=/etc/systemd/system/minidlna.service.d/home.conf
    - service: name=minidlna state=started enabled=yes

    - pacman: name=nginx
    - template: src=nginx.conf dest=/etc/nginx/nginx.conf
    - copy: src=redirects dest=/etc/nginx/redirects
    - copy: src=../../secrets/1_zahe.me_bundle.crt dest=/etc/nginx/zahe.me.crt
    - copy: src=../../secrets/2_zahe.me.key dest=/etc/nginx/zahe.me.key
    - service: name=nginx state=reloaded enabled=yes

    - pacman: name=openvpn
    - template: src=openvpn_kub.conf dest=/etc/openvpn/kub.conf
    - service: name=openvpn@kub state=started enabled=yes

    - pacman: name=uwsgi-plugin-php
    - git: repo=https://github.com/owncloud/core dest=/home/hdhoang/owncloud recursive=yes
      become: no
    - git: repo=https://github.com/owncloud/news dest=/home/hdhoang/owncloud/apps/news
      become: no
    - template: src=owncloud.ini dest=/etc/uwsgi/owncloud.ini
    - service: name=uwsgi@owncloud state=restarted enabled=yes

    - template: src=ipsec.conf dest=/etc/ipsec.conf
    - copy: src=../../secrets/1_k.zahe.me_bundle.crt dest=/etc/ipsec.d/certs/k.zahe.me.crt
    - copy: src=../../secrets/2_k.zahe.me.key dest=/etc/ipsec.d/private/k.zahe.me.key
    - copy: src=../../secrets/1_ton.zahe.me_bundle.crt dest=/etc/ipsec.d/certs/ton.zahe.me.crt
    - lineinfile: "line=': RSA k.zahe.me.key' name=/etc/ipsec.secrets create=yes mode=0600 state=present"
    - include: eap.task
    - service: name=strongswan state=started enabled=yes

    - pacman: name=tor
    - template: src=torrc dest=/etc/tor/torrc
    - service: name=tor state=started enabled=yes
