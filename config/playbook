#!/bin/ansible-playbook --ask-become-pass
# -*- mode: yaml -*-
- hosts: all
  become: yes
  tasks:
    - template: src=hosts dest=/etc/
    - group: name={{user}} gid=1000
    - user: name={{user}} uid=1000 createhome=no group={{user}} groups=wheel,systemd-journal,uucp,wireshark shell=/bin/zsh
    - lineinfile: dest=/etc/pacman.d/mirrorlist insertbefore=BOF line="Server = http://f.archlinuxvn.org/archlinux/$repo/os/$arch"
      become: yesnn
    - ini_file: dest=/etc/pacman.conf section=multilib option=Include value=/etc/pacman.d/mirrorlist
    - ini_file: dest=/etc/pacman.conf section=blackarch option=Server value=http://f.archlinuxvn.org/blackarch/$repo/os/$arch
    - lineinfile: dest=/etc/pacman.conf line={{item}} insertafter=options
      with_items:
        - UseSyslog
        - Color
        - VerbosePkgLists
    - command: pacman-key -r 7533bafe69a25079
    - command: pacman-key --lsign 7533bafe69a25079 
    - pacman: state=absent name={{item}}
      with_items:
        - jfsutils
        - lvm2
        - nano
        - mdadm
        - netctl
        - reiserfsprogs
        - dhcpcd
        - xfsutils
    - name: utils
      pacman: name={{item}}
      with_items:
        - acpi
        - dhclient
        - dosfstools
        - git
        - haveged
        - lm_sensors
        - mlocate
        - net-tools
        - ntfs-3g
        - openssh
        - p7zip
        - parallel
        - pkgfile
        - pv
        - tcpdump
        - traceroute
        - tree
        - uucp
        - vim
        - wget
        - wpa_supplicant
        - zsh
    - command: pkgfile -u creates=/var/cache/pkgfile/core.files
    - service: name=haveged state=started enabled=yes
    - mount: src=LABEL=home name={{home}} fstype=ntfs-3g opts=permissions state=present
      when: ansible_hostname == 'ton'
    - mount: src=LABEL=ESP name=/boot fstype=vfat state=present
      when: ansible_hostname == 'ton'
    - lineinfile: dest=/etc/sudoers line="%wheel ALL = (ALL) ALL" validate="visudo -c -f %s"
    - name: locale
      file: state=link src=../usr/share/zoneinfo/Asia/Ho_Chi_Minh path=/etc/localtime
    - lineinfile: dest=/etc/locale.gen line="{{locale}}.UTF-8 UTF-8"
    - lineinfile: dest=/etc/locale.conf line="LANG={{locale}}.UTF-8"
    - command: locale-gen
    - copy: src=caps2ctrl.map dest=/usr/share/kbd/keymaps/
    - copy: dest=/etc/vconsole.conf content="KEYMAP=caps2ctrl"
    - name: desktop
      when: ansible_hostname == 'ton'
      pacman: name={{item}}
      with_items:
        - breeze-kde4
        - cantata
        - chromaprint
        - chromium
        - dolphin
        - emacs-pkgbuild-mode
        - firefox
        - gtk-theme-orion
        - ibus-anthy
        - ibus-qt
        - ibus-unikey
        - kdegraphics-ksnapshot
        - kdemultimedia-kmix
        - mesa-libgl
        - mpc
        - mpd
        - mpv
        - picard
        - plasma-desktop
        - plasma-nm
        - pulseaudio-alsa
        - rust
        - sddm
        - steam
        - syncthing
        - ttf-hannom
        - ttf-linux-libertine
        - virtualbox-guest-iso
        - virtualbox-host-dkms
        - wine
        - wireshark-gtk
        - xf86-input-libinput
        - xf86-input-wacom
        - xf86-video-intel
        - xorg-server
        - xorg-xinput
        - yakuake
    - copy: src=keyboard.conf dest=/etc/X11/xorg.conf.d/
      when: ansible_hostname == 'ton'
    - copy: src={{ansible_hostname}}/pointer.conf dest=/etc/X11/xorg.conf.d/
      when: ansible_hostname == 'ton'
    - pacman: name=acpid
      when: ansible_hostname == 'ton'
    - template: src={{ansible_hostname}}/rotation-button dest=/etc/acpi/events/
      when: ansible_hostname == 'ton'
    - service: name=acpid state=started enabled=yes
      when: ansible_hostname == 'ton'
    - command: rustc --out-dir /usr/local/bin {{conf}}/rotate-screen.rs
      when: ansible_hostname == 'ton'

    - name: openvpn
      pacman: name=openvpn
    - template: src={{conf}}/kub.ovpn dest=/etc/openvpn/kub.conf
    - service: name=openvpn@kub state=started enabled=yes
      when: ansible_hostname == 'kub'

    - name: strongswan
      template: src={{conf}}/ipsec.conf dest=/etc/
    - copy: src={{h}}/secrets/1_{{ansible_hostname}}.zahe.me_bundle.crt dest=/etc/ipsec.d/certs/{{ansible_hostname}}.crt
    - copy: src={{h}}/secrets/2_{{ansible_hostname}}.zahe.me.key dest=/etc/ipsec.d/private/{{ansible_hostname}}.key
    - lineinfile: "create=yes dest=/etc/ipsec.secrets line=': RSA {{ansible_hostname}}.key'"
    - copy: src={{h}}/secrets/1_ton.zahe.me_bundle.crt dest=/etc/ipsec.d/certs/ton.zahe.me.crt
      when: ansible_hostname == 'kub'
    - include: kub/eap.task
    - service: name=strongswan state=started enabled=yes


    - pacman: name=powertop
    - copy: src={{conf}}/powercfg dest=/usr/local/bin/ mode=0744
      when: ansible_hostname == 'ton'
    - copy: src={{conf}}/powercfg.service dest=/etc/systemd/system/
      when: ansible_hostname == 'ton'
    - service: name=powercfg state=started enabled=yes
      when: ansible_hostname == 'ton'

    - name: links
      become: no
      file: state=link src=appdata/Mozilla path={{home}}/.mozilla
    - copy: src={{conf}}/syncthing/ dest={{home}}/.config/syncthing/
      become: no
    - template: src={{conf}}/syncthing/config.xml dest={{home}}/.config/syncthing/
      become: no
    - file: state=link src={{h}}/config/dotconfig/{{item}} path={{home}}/.config/{{item}}
      become: no
      with_items:
        - fontconfig
        - mpv
        - kwinrulesrc
        - youtube-dl.conf
        - MusicBrainz
    - file: state=link src={{h}}/config/dot{{item}} path={{home}}/.{{item}}
      become: no
      with_items:
        - ansible.cfg
        - emacs
        - gitconfig
        - mpdconf
        - pam_environment
        - ssh
    - file: state=link src={{h}}/config/shrc path={{home}}/.zshrc
      become: no
    - file: state=link src={{h}}/config/_pentadactylrc path={{home}}/.pentadactylrc
      become: no

    - name: network
      when: ansible_hostname == 'kub'
      template: src={{ansible_hostname}}}/eth0.network dest=/etc/systemd/network/
    - lineinfile: dest=/etc/resolv.conf line="nameserver {{ network }}.1"
      when: ansible_hostname == 'kub'
    - service: name=systemd-networkd state=started enabled=yes
      when: ansible_hostname == 'kub'

    - name: sshd
      when: ansible_hostname == 'kub'
      lineinfile: dest=/etc/ssh/sshd_config line="AuthenticationMethods publickey keyboard-interactive:pam"
    - name: leds
      when: ansible_hostname == 'kub'
      copy: src={{ansible_hostname}}/leds dest=/usr/local/bin/ mode=744
    - copy: src={{ansible_hostname}}/leds.service dest=/etc/systemd/system/
      when: ansible_hostname == 'kub'
    - service: name=leds state=started enabled=yes
      when: ansible_hostname == 'kub'

    - name: minidlna
      pacman: name=minidlna
      when: ansible_hostname == 'kub'
    - template: src={{ansible_hostname}}/minidlna.conf dest=/etc/
      when: ansible_hostname == 'kub'
    - copy: src={{ansible_hostname}}/minidlna_home.conf dest=/etc/systemd/system/minidlna.service.d/
      when: ansible_hostname == 'kub'
    - service: name=minidlna state=started enabled=yes
      when: ansible_hostname == 'kub'

    - name: nginx
      pacman: name=nginx
      when: ansible_hostname == 'kub'
    - template: src={{conf}}/nginx.conf dest=/etc/nginx/
      when: ansible_hostname == 'kub'
    - copy: src={{conf}}/redirects dest=/etc/nginx/
      when: ansible_hostname == 'kub'
    - copy: src={{h}}/secrets/1_zahe.me_bundle.crt dest=/etc/nginx/zahe.me.crt
      when: ansible_hostname == 'kub'
    - copy: src={{h}}/secrets/2_zahe.me.key dest=/etc/nginx/zahe.me.key
      when: ansible_hostname == 'kub'
    - service: name=nginx state=reloaded enabled=yes
      when: ansible_hostname == 'kub'

    - name: owncloud
      pacman: name=uwsgi-plugin-php
      when: ansible_hostname == 'kub'
    - git: repo=https://github.com/owncloud/core dest={{home}}/owncloud
      become: no
      when: ansible_hostname == 'kub'
    - git: repo=https://github.com/owncloud/news dest={{home}}/owncloud/apps/news
      become: no
      when: ansible_hostname == 'kub'
    - template: src=owncloud.ini dest=/etc/uwsgi/
      when: ansible_hostname == 'kub'
    - service: name=uwsgi@owncloud state=started enabled=yes
      when: ansible_hostname == 'kub'

    - name: tor
      pacman: name=tor
    - template: src=torrc dest=/etc/tor/torrc
      when: ansible_hostname == 'kub'
    - service: name=tor state=started enabled=yes
      when: ansible_hostname == 'kub'
